# Academic Research Network - 深度架构设计 V2

> 基于用户深入反馈的重新思考

---

## 你告诉我的核心洞见

### 1. 工作流的真正本质

| 工作流 | 你说的本质 | 我之前理解的 |
|-------|----------|------------|
| `/start` | **载入上下文** - 让AI知道"我们现在在哪" | 状态检查 |
| `/create-pr` | **开启有边界的任务空间** - 新的话题容器 | 创建文件 |
| `/merge-pr` | **任务收割+对齐** - 正式改动的仪式 | 合并修改 |
| `/deep-read` | **像博士生一样批判性地读** - 真正理解、质疑 | 提取要点 |
| `/reflect` | **提取用户模式** - 你的风格、偏好、思维方式 | 记录笔记 |

### 2. 你发现的核心问题

| 问题 | 表现 | 根因 |
|-----|-----|-----|
| **生硬阅读** | "跟我们有12点相关" | 没有自己的思考，只是机械匹配 |
| **过度服从** | 用户说啥是啥 | 没有独立判断，没有批判性 |
| **过度批判** | 质疑一切但没有建设性 | 批判框架不完整 |
| **缺乏全局** | 忘了之前讨论的内容 | 没有持续的上下文管理 |
| **重复解释** | 用户一遍一遍说同样的话 | 没有提取和记住用户模式 |

### 3. 你给的关键原则

- **文档是AI的大脑** - AI没有长期记忆，文档就是记忆
- **PR是对话边界** - 在PR内应该有连续的上下文理解
- **用户输入要保存** - 用户的高质量反馈体现风格和要求
- **精确引用原文** - 防止AI幻觉叠加，原材料直接展示
- **每个Agent要有独特视角** - 不是不同功能，是不同思维方式

---

## 新架构：三层设计

```
┌─────────────────────────────────────────────────────────────────┐
│                     Layer 1: 上下文管理层                        │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  PR Scope (任务边界)                                         ││
│  │  - 每个PR是一个独立的对话空间                                 ││
│  │  - 包含：tasks, context, requirements, memory fragments      ││
│  │  - 连续的上下文理解                                          ││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  Global Context (全局上下文)                                 ││
│  │  - _CONTEXT.md: 当前研究状态                                 ││
│  │  - MEMORY.md: 用户偏好、洞见、决策                            ││
│  │  - Draft.md 结构理解                                         ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     Layer 2: 思维者层                           │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Facilitator │  │ Deep Reader  │  │   Critic     │          │
│  │  (协调者)    │  │ (深度阅读者) │  │  (批判者)    │          │
│  │              │  │              │  │              │          │
│  │ 全局理解     │  │ 像博士生读   │  │ 六顶帽子思考 │          │
│  │ 用户意图     │  │ 临时想法记录 │  │ 独立判断     │          │
│  │ 任务分解     │  │ 分块+索引    │  │ 建设性质疑   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐                             │
│  │ Memory Keeper│  │  Archivist   │                             │
│  │ (记忆管理者) │  │ (档案员)     │                             │
│  │              │  │              │                             │
│  │ Mem0集成     │  │ 精确引用     │                             │
│  │ 用户模式提取 │  │ 文件操作     │                             │
│  │ 冲突检测     │  │ 索引维护     │                             │
│  └──────────────┘  └──────────────┘                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     Layer 3: 工具层                              │
│                                                                  │
│  文献工具          文件工具           记忆工具                   │
│  - search_lit()    - read_file()     - mem0_add()              │
│  - read_chunk()    - write_file()    - mem0_search()           │
│  - check_cite()    - update_index()  - detect_conflict()       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Agent 详细设计

### Agent 1: Facilitator (协调者)

**核心职责**：全局理解 + 任务编排

**独特视角**：像一个项目经理，知道大局，知道每个人擅长什么

**能力**：
1. 载入全局上下文（`/start`）
2. 理解用户真正意图（不是表面说的）
3. 判断需要调用谁
4. 合成最终输出

**关键问题解决**：
- 防止"用户说啥是啥" → 在转发任务前先评估意图
- 维持连续对话 → 管理 PR Scope 内的上下文

---

### Agent 2: Deep Reader (深度阅读者)

**核心职责**：像博士生一样真正理解文献

**独特视角**：不是匹配关键词，而是真正理解作者在说什么

**思维流程**：

```
1. 预估阅读量
   - 检查文献长度
   - 判断是否需要分块
   
2. 结构化阅读（不是直接输出结论）
   - 读每个部分，记录"我看到了什么"
   - 记录临时想法（"这里好像有问题...待验证"）
   
3. 批判性评估（对自己的理解也批判）
   - 论证强度如何？
   - 方法论有没有问题？
   - 有没有我遗漏的？
   
4. 创建可溯源笔记
   - 每个要点指向原文位置
   - 别人可以从笔记跳回原文验证
   
5. 与我们研究的关联
   - 带着已有context看
   - 不是机械匹配，是思考式关联
```

**产出**：索引化的阅读笔记，可溯源，有临时想法，有批判

---

### Agent 3: Critic (批判者)

**核心职责**：独立的批判性思维

**独特视角**：用思维框架保证严谨性，不是为了反对而反对

**思维框架**（参考六顶帽子）：

| 帽子 | 视角 | 问什么 |
|-----|-----|-------|
| 白帽 | 事实 | 我们知道什么？不知道什么？ |
| 黄帽 | 乐观 | 这个想法的价值是什么？ |
| 黑帽 | 批判 | 有什么风险？逻辑有问题吗？ |
| 绿帽 | 创意 | 有没有其他可能？ |
| 红帽 | 直觉 | 我的第一反应是什么？ |
| 蓝帽 | 过程 | 我们该怎么组织这个思考？ |

**关键问题解决**：
- 防止"过度服从" → 主动提出质疑
- 防止"过度批判" → 必须有黄帽（价值）和绿帽（替代方案）

---

### Agent 4: Memory Keeper (记忆管理者)

**核心职责**：提取和维护用户模式

**独特视角**：不是记录发生了什么，而是提取"用户是什么样的人"

**能力**：
1. **Mem0 集成**：智能记忆存储和检索
2. **用户模式提取**：
   - 这次没法提取，存下来，下次可能能提取
   - 用户说话的风格
   - 用户的偏好和要求
3. **冲突检测**：用户之前说A，现在说B，要确认
4. **MEMORY.md 维护**：文档化的记忆，防止丢失

**关键问题解决**：
- 防止"重复解释" → 提取并记住用户的表达模式
- 用户高质量输入要保存 → 即使暂时不理解其价值

---

### Agent 5: Archivist (档案员)

**核心职责**：精确的文档操作

**独特视角**：AI可能产生幻觉，但原材料不会

**原则**：
1. **精确引用** - 不让AI重述，直接展示原文
2. **可溯源** - 每个引用都能追溯到来源
3. **索引维护** - 保持所有INDEX文件同步
4. **PR对齐** - merge时确保所有状态一致

**工具**：
- `quote_original(file, start, end)` - 精确引用原文
- `update_index(index_file, entry)` - 更新索引
- `sync_references()` - 同步引用检查

---

## 工作流与Agent的映射

### `/start` - 上下文载入

```
触发: 用户开始新对话
执行者: Facilitator
流程:
1. 读取 _CONTEXT.md（当前研究状态）
2. 读取 MEMORY.md（用户偏好、历史洞见）
3. 检查活跃的 PR
4. 输出简洁状态报告
```

### `/create-pr` - 开启任务空间

```
触发: 用户想要修改论文内容
执行者: Facilitator + Archivist
流程:
1. Facilitator 理解修改意图
2. Archivist 创建 PR 文件和索引
3. 初始化 PR Scope（独立的对话上下文）
4. 后续对话在这个 Scope 内有连续记忆
```

### `/deep-read` - 博士生式阅读

```
触发: 用户要求深度阅读某文献
执行者: Deep Reader + Critic
流程:
1. Deep Reader 预估阅读量，决定分块策略
2. 逐块阅读，记录临时想法
3. Critic 审阅 Deep Reader 的理解
4. 创建可溯源的索引笔记
5. 输出结构化报告+临时想法+批判点
```

### `/merge-pr` - 任务收割

```
触发: 用户确认可以合并
执行者: Archivist + Facilitator + Memory Keeper
流程:
1. Archivist 执行 10 步验证
2. Archivist 精确修改文档（引用原文）
3. 同步所有相关文件
4. Memory Keeper 提取这个PR中的洞见
5. Facilitator 关闭 PR Scope
```

### `/reflect` - 模式提取

```
触发: 重要讨论后
执行者: Memory Keeper
流程:
1. 回顾对话，不是记录事件，而是提取模式
2. 用户说了什么有价值的话？
3. 体现了什么偏好/风格？
4. 与现有记忆冲突吗？
5. 更新 Mem0 + MEMORY.md
```

---

## PR Scope: 任务边界的上下文管理

这是你强调的核心概念：**PR是一个对话边界**

```
┌─────────────────────────────────────────────┐
│               PR-0010 Scope                 │
│                                             │
│  context: {                                 │
│    goal: "修改 Introduction 关于 Gen Z",    │
│    started: "2025-12-27",                   │
│    related_literature: [...],              │
│    tasks: [                                 │
│      { id: 1, desc: "找支持文献", done },   │
│      { id: 2, desc: "批判性审查", doing },  │
│      { id: 3, desc: "合并修改", pending }   │
│    ],                                       │
│    conversation_memory: [                   │
│      "用户说要强调Z世代的自主性",           │
│      "我们讨论了Schroth 2019的相关性"       │
│    ]                                        │
│  }                                          │
│                                             │
│  在这个Scope内的对话有连续的上下文理解      │
└─────────────────────────────────────────────┘
```

---

## 与现有系统的集成

### Mem0 集成

```python
# Memory Keeper 使用 Mem0
class MemoryKeeper:
    def add_memory(self, content, user_id, category):
        # 存入 Mem0
        self.mem0.add(content, user_id=user_id, metadata={"category": category})
        # 同时同步到 MEMORY.md（防止丢失）
        self.sync_to_markdown()
    
    def extract_pattern(self, conversation):
        # 不只是记录事件，而是提取用户模式
        # "用户倾向于用类比说明复杂概念"
        # "用户对方法论细节很敏感"
        pass
```

### OpenAgents 集成

```yaml
# 使用 Messaging 模式，不是 Project 模式
# 用户通过 Channel 或 Direct Message 与 Facilitator 对话
# Facilitator 内部调用其他 Agent

network:
  mods:
    - name: "openagents.mods.workspace.messaging"
      enabled: true
    # 可以保留 project mod 用于 PR Scope 管理
    - name: "openagents.mods.workspace.project"  
      enabled: true
```

---

## 下一步

1. **验证这个架构**：你觉得这样理解对了吗？
2. **确定实现优先级**：先实现哪些Agent？
3. **PR Scope 如何实现**：OpenAgents的Project能否承载这个概念？
4. **六顶帽子框架**：Critic 的思维框架需要更详细的设计吗？
