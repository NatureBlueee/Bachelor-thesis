# 论文协作系统增强方案

> **状态**：Planning
> **创建**：2025-12-19
> **目的**：梳理如何增强现有系统，独立于参赛

---

## 核心定位回顾

从 Reflections 文档提炼的本质：

> **把隐性思考显性化、把随意修改结构化、把临时对话持久化、把人机协作规范化**

这不是"论文工具"，是一种**工作方法论**。

---

## 问题诊断（2025-12-19 实际反馈）

> 以下是在真实使用中发现的问题，比理论分析更重要。

### 记忆层（MEMORY.md）⚠️ 问题最大

| 问题 | 表现 | 根因猜测 |
|------|------|---------|
| 调用不准确 | 该记的没记，不该记的记了 | 触发条件定义模糊 |
| 记忆选择差 | 记的内容不是最重要的 | 缺乏"重要性评估"机制 |
| 不灵敏 | 不会主动写入 | 被动等待指令，缺乏自主判断 |
| 草稿粗糙 | 格式和内容质量不高 | 没有结构化模板 |

**核心问题**：记忆不是"自动发生"的，需要用户主动说"记住"。但好的记忆系统应该**自己知道什么值得记**。

### 知识层（Reference/）⚠️ 检索是痛点

| 问题 | 表现 | 根因猜测 |
|------|------|---------|
| 检索不深入 | 问文献里有没有X，AI说没有，实际有 | 没有细粒度索引 |
| 同步性差 | 新加的文献不被感知 | 索引没有自动更新 |
| 阅读太大 | 一次读整篇文献效率低 | 缺乏分层索引（摘要→章节→段落） |

**其他产品的思路**：
- **不是RAG那种"向量模糊匹配"**
- 而是**多层索引**：先读摘要知道大概有什么 → 再定位具体章节 → 再精读段落
- 这更像人类阅读方式

### 讨论层（Consensus/）

| 问题 | 表现 | 根因猜测 |
|------|------|---------|
| 无法操作网页端 | Consensus App 没有 MCP/API | 外部工具限制 |
| 问答流程断裂 | 需要手动复制粘贴 | 缺乏自动化桥接 |

**可能的方向**：
- 如果 Consensus 没有 API，考虑用浏览器自动化（Playwright）
- 或者换一个有 API 的学术搜索工具

### 变更层（PR/）

| 问题 | 表现 | 根因猜测 |
|------|------|---------|
| 多次讨论难管理 | 一个PR持续修改，历史难追溯 | PR没有"讨论线程"概念 |
| 待办管理缺失 | 有计划无跟踪 | 没有独立的TODO系统 |
| 同步性差 | 其他地方规划的细节没记住 | 各模块信息孤岛 |
| 不会主动找相关 | 已完成的事又被提起 | 缺乏"状态感知"能力 |

**核心问题**：PR是"静态文件"，不是"活的对象"。它不知道自己和其他内容的关系。

### 规则层（.agent/rules/）

| 问题 | 表现 | 根因猜测 |
|------|------|---------|
| 调用不主动 | 需要手动提规则才会用 | AI IDE可能不自动加载 |
| 可能是IDE问题 | Antigravity vs Cursor 表现不同 | 不同IDE的规则加载机制不同 |

### 进度层（_CONTEXT.md）

| 问题 | 表现 | 根因猜测 |
|------|------|---------|
| 修改标准不一 | 每次改的逻辑不同 | 没有明确的"更新触发条件" |
| 偏离初衷 | 原本是给外部AI窗口的 | 功能蔓延，定位模糊 |
| 内容混乱 | 不知道应该包含什么 | 没有严格的schema |

**初衷回顾**：`_CONTEXT.md` 最初是为了让**任何AI窗口**（包括外部工具）都能快速了解"我们在做什么"。

---

## 核心洞察

**问题的根源不是"功能缺失"，是"感知缺失"。**

系统的各层是**静态文件**，它们：
- 不知道彼此的存在
- 不知道自己的状态变化
- 不会主动同步
- 不会主动检索相关内容

**解决方向**：需要某种"中央协调器"或"事件系统"，让各层能够**感知变化并响应**。

这正是 **Multi-Agent 架构** 可以解决的问题——每个Agent负责一个层，Agent之间可以通信和协调。

---

## 当前系统组件

| 层 | 文件 | 功能 | 成熟度 |
|----|------|------|--------|
| 规则层 | `.agent/rules/` | AI行为约束 | ⭐⭐⭐ 完善 |
| 工作流层 | `.agent/workflows/` | 操作流程 | ⭐⭐⭐ 完善 |
| 知识层 | `Reference/` | 文献库 | ⭐⭐⭐ 完善 |
| 讨论层 | `Consensus/` | 学术问答 | ⭐⭐ 基本可用 |
| 变更层 | `PR/` | 修改管理 | ⭐⭐⭐ 完善 |
| 产出层 | `Target/` | 论文正文 | ⭐⭐⭐ 完善 |
| 记忆层 | `MEMORY.md` | AI笔记 | ⭐ 需升级 |
| 进度层 | `_CONTEXT.md` | 研究进度 | ⭐⭐ 基本可用 |

---

## 增强优先级

### P0：记忆系统升级（立即可做）

**现状**：单一的 `MEMORY.md` 文件，手动维护

**问题**：
- 没有自动沉淀"成功/失败模式"
- 没有区分长期/短期记忆
- 每次对话都加载全部内容，效率低

**方案A：使用 OpenMemory MCP（推荐）**

```bash
# 一行命令集成到Cursor
npx @openmemory/install --client cursor --env OPENMEMORY_API_KEY=your-key
```

暴露的工具：
- `add_memories` → 存储新记忆
- `search_memory` → 检索相关记忆
- `list_memories` → 查看所有记忆

**集成后的使用方式**：
- 在对话中说"记住这个"，AI自动调用 `add_memories`
- 在新对话开始时，AI自动调用 `search_memory` 检索相关上下文

**方案B：自建分层记忆结构（备选）**

```
MEMORY/
├── core.md          # 核心认知（用户偏好、项目定位）—— 几乎不变
├── session.md       # 当前会话状态 —— 每次对话清空
├── insights.md      # 形成的洞见 —— 持续积累
└── patterns.md      # 成功/失败模式 —— AI自动沉淀
```

### P1：文献索引空间化

**现状**：`Reference/_INDEX.md` 是简单的文献列表

**问题**：50+篇文献时，很难一眼看出"哪些支撑P1、哪些支撑P4"

**方案**：按理论框架分组

```markdown
## 文献地图

### 资源依赖理论 (P1, P2, P3)
- Pfeffer & Salancik (1978) - 原始理论
- Tripathi (2021) - 员工层面扩展 ← **核心**

### AI素养 (自变量)
- 钟柏昌 (2024) - 三维框架定义
- Ng et al. (2023) - ABCE模型

### Z世代特征 (调节机制)
- Schroth (2019) - 尊重=被倾听
- Seemiller & Grace (2016) - 数字原住民
```

### P2：元规划工作流

**现状**：写新章节是"想到哪写到哪，边写边开PR"

**方案**：新增 `/plan-chapter` 工作流

```markdown
## Chapter 4 写作规划

### 结构
- 4.1 Participant Overview (预估 1 PR)
- 4.2 Theme 1: [待定] (预估 2 PR)

### 依赖检查
- [ ] 访谈数据完成？
- [ ] 编码方案确定？

### 预计文献需求
- 主题分析方法论 → Braun & Clarke OK
- Z世代职场心态 → Schroth OK
```

### P3：可追溯性增强

**现状**：引用格式是 `(Author, Year)`，但没有直接链接到文献原文

**方案**：在 Draft.md 里，每个核心论点标注文献卡片链接

```markdown
Tripathi (2021) argues that employees can be "hosts of tacit resources"
[[→ Reference/PDF-MD/output_api/Tripathi_2021.md#L45-L67]]
```

点击可直接跳到文献原文的具体段落。

---

## 行业实践参考（2025-12-19 搜索结果）

> 针对上述问题，从行业内找到的解决方案。

---

### 记忆层：Mem0 的设计

**核心架构**：Hybrid Datastore
- **Vector Database**：存储记忆的语义嵌入（ChromaDB）
- **Graph Database**：存储实体之间的关系（Neo4j）

**三阶段管道**：
1. **Extraction（提取）**：用 LLM 分析对话，识别"值得记住的信息"
2. **Consolidation（整合）**：对比新旧记忆，决定是 add/update/delete
3. **Retrieval（检索）**：语义搜索 + 图关系 + 重要性权重

**自动触发机制**：
- 每次新对话/新轮次自动触发
- 通过 `add()` 方法调用整个管道
- **关键**：用 `MEMORY_DEDUCTION_PROMPT` 让 LLM 判断"什么值得记"

**启示**：
- 我们的 MEMORY.md 缺乏"自动判断"——需要 LLM 参与决定记什么
- 需要 Consolidation 步骤——避免重复和矛盾
- 可以用 OpenMemory MCP 直接集成

---

### 知识层：Heptabase 的多层索引

**核心概念**：Whiteboard + Card + Section

**层级结构**：
```
Whiteboard（白板）= 文件夹
  └── Section（分区）= 主题分组
       └── Card（卡片）= 原子知识单元
```

**多层索引方式**：
1. **两层白板结构**：顶层白板（"Projects" "Topics"）→ 子白板（具体项目）
2. **Section 导航**：Section 标题自动生成目录，点击跳转
3. **双向链接**：卡片之间、卡片与白板之间互相链接
4. **颜色索引**：用颜色标记不同类型的卡片（如蓝色=索引卡）

**对我们的启示**：
```
Reference/
├── _INDEX.md          # 第一层：按理论框架分组的入口
├── _SUMMARIES/        # 第二层：每篇文献的摘要卡片
│   ├── Tripathi_2021.md  (200字摘要+关键论点)
│   └── ...
└── PDF-MD/            # 第三层：完整正文
    ├── Tripathi_2021.md
    └── ...
```

**检索流程**：
1. 先查 `_INDEX.md` → 找到"资源依赖理论"分组
2. 浏览分组中的文献摘要 → 定位 Tripathi_2021
3. 需要原文细节 → 跳转到 PDF-MD 对应文件的具体行号

---

### 同步层：LangGraph 的 Checkpoint 机制

**核心问题**：如何让长程工作流保持状态一致？

**LangGraph 的解决方案**：Checkpointer

**关键概念**：
1. **StateSnapshot**：每个节点执行后自动保存状态快照
2. **Thread ID**：用唯一标识符组织状态，可随时恢复
3. **Reducer**：定义新数据如何与旧数据合并（不是覆盖）

**保存的内容**：
- 当前所有状态变量的值
- 下一步要执行的节点
- 待处理的任务
- 配置和元数据

**对我们的启示**：
- 需要一个"状态管理器"，记录每次操作后的系统状态
- PR/Consensus/Context 的变更应该触发自动 checkpoint
- 可以回溯到之前的状态（"时间旅行"调试）

**简化版实现思路**：
```markdown
# _STATE.md

## 最后更新：2025-12-19 12:30

### 活跃 PR
- PR-0005: [planning] Interview Guide Upgrade

### 最近 Consensus
- CON-0003: 上级开放性测量（已关闭）

### 待办
- [ ] 完成 PR-0005 细化
- [ ] 准备 Pilot 访谈

### 文献状态
- 新增：0
- 待读：3
```

---

### 待深入研究的项目

| 项目 | 解决的问题 | 参考链接 |
|------|-----------|---------|
| **Mem0** | 记忆自动提取与整合 | [docs.mem0.ai](https://docs.mem0.ai) |
| **Heptabase** | 多层知识索引 | [heptabase.com/docs](https://wiki.heptabase.com) |
| **LangGraph** | 状态同步与checkpoint | [langchain.com/langgraph](https://langchain.com/langgraph) |
| **data-to-paper** | 可追溯性设计 | [GitHub](https://github.com/Technion-Kishony-lab/data-to-paper) |
| **Magentic-One** | 双层账本（Task/Progress Ledger） | [Microsoft AutoGen](https://github.com/microsoft/autogen) |

---

## 行动计划

### 本周（12月19日-25日）
- [ ] 注册 OpenMemory，获取 API Key
- [ ] 在 Cursor 集成 OpenMemory MCP
- [ ] 测试：在对话中使用 add_memories / search_memory
- [ ] 重构 `Reference/_INDEX.md` 为分组结构

### 下周（12月26日-31日）
- [ ] 创建 `/plan-chapter` 工作流
- [ ] 试用：用工作流规划 Chapter 4
- [ ] （如果参赛）启动 OpenAgents 环境

### 长期（2025年1月+）
- [ ] 探索可追溯性增强
- [ ] 探索自动模式沉淀
- [ ] 考虑开源

---

## 笔记

> 核心问题是增强**记忆能力**和**多步思考能力**，去研究深入的东西。
> 
> 这个过程中需要**长期记忆和短期记忆的结合**，还有**预定好的提示词**。

——用户，2025-12-19
